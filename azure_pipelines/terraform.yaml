name: Terraform_MultiEnv_Pipeline

schedules:
- cron: "0 8 * * *"
  displayName: 'Daily drift detection'
  branches:
    include:
    - main
    - develop 
  always: true

trigger:
  branches:
    include:
      - main
      - develop

variables:
  azureServiceConnection: 'your-service-connection-name'
  terraformVersion: '1.7.0'
  # Note: Variable groups are usually called like this:
    #- group: terraform-secrets 

stages:
- stage: validate
  displayName: 'Validation'
  jobs:
  - job: terraform_validate
    pool:
      vmImage: 'agent-pool' # Change 'agent-pool' to your actual pool name
    steps:
    - task: TerraformInstaller@1
      inputs:
        terraformVersion: $(terraformVersion)
    - script: |
        chmod +x validate_all.sh
        ./validate_all.sh
      displayName: 'Run Multi-Env Validation Script'

- stage: Dev_Deployment
  displayName: 'Dev Deployment'
  dependsOn: validate
  condition: succeeded()
  jobs:
  - job: Terraform_plan
    displayName: 'Terraform Plan (Dev)'
    pool:
      vmImage: 'agent-pool'
    steps:
    - checkout: self
    - task: TerraformTaskV4@4
      displayName: 'Terraform Init'
      inputs:
        provider: 'azurerm'
        command: 'init'
        workingDirectory: '$(System.DefaultWorkingDirectory)/environments/dev'
        backendServiceArm: $(azureServiceConnection)
        backendAzureRmResourceGroupName: 'rg-terraform-state' # Ensure this is filled
        backendAzureRmStorageAccountName: 'stterraformstateprimary'
        backendAzureRmContainerName: 'dev-tfstate'
        backendAzureRmKey: 'dev_terraform.tfstate'

    - task: TerraformTaskV4@4
      displayName: 'Terraform Plan'
      inputs:
        provider: 'azurerm'
        command: 'plan'
        workingDirectory: '$(System.DefaultWorkingDirectory)/environments/dev'
        environmentServiceNameAzureRM: $(azureServiceConnection)
        commandOptions: '-var-file="terraform.tfvars" -out=dev.tfplan'

    - task: PublishPipelineArtifact@1
      displayName: 'Publish Plan Artifact'
      inputs:
        targetPath: '$(System.DefaultWorkingDirectory)/environments/dev/dev.tfplan'
        artifact: 'dev-tfplan-file'

# Below stage will generate auto PR on validate and plan success

- stage: Create_PR
  displayName: 'Auto Create Pull Request'
  dependsOn: Dev_Deployment
  condition: and(succeeded(), ne(variables['Build.Reason'], 'Schedule')) # Don't PR on drift checks
  jobs:
  - job: Create_PR_Job
    pool: { vmImage: 'agent-pool' }
    steps:
    - checkout: self
      persistCredentials: true
    - script: |
        export AZURE_DEVOPS_EXT_PAT=$(System.AccessToken)
        SOURCE_BRANCH=$(Build.SourceBranchName)
        TARGET_BRANCH="main"
        TITLE="Auto-PR: Merging $SOURCE_BRANCH into $TARGET_BRANCH"
        
        EXISTING_PR=$(az repos pr list --source-branch $SOURCE_BRANCH --target-branch $TARGET_BRANCH --status active --query "[].pullRequestId" -o tsv)

        if [ -z "$EXISTING_PR" ]; then
          az repos pr create \
            --source-branch $SOURCE_BRANCH \
            --target-branch $TARGET_BRANCH \
            --title "$TITLE" \
            --status active
        else
          echo "ℹ️ PR already exists."
        fi
      displayName: 'Run az repos pr create'
      env:
        SYSTEM_ACCESSTOKEN: $(System.AccessToken)

- stage: Apply_Dev
  displayName: 'Apply Dev'
  dependsOn: Dev_Deployment
  condition: succeeded()
  jobs:
  - deployment: Terraform_Apply
    environment: 'development'
    pool: { vmImage: 'agent-pool' }
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: 'dev-tfplan-file'

          - task: TerraformTaskV4@4
            displayName: 'Terraform Init'
            inputs:
              provider: 'azurerm'
              command: 'init'
              workingDirectory: '$(System.DefaultWorkingDirectory)/environments/dev'
              backendServiceArm: $(azureServiceConnection)
              backendAzureRmResourceGroupName: 'rg-terraform-state'
              backendAzureRmStorageAccountName: 'stterraformstateprimary'
              backendAzureRmContainerName: 'dev-tfstate'
              backendAzureRmKey: 'dev_terraform.tfstate'

          - task: TerraformTaskV4@4
            displayName: 'Terraform Apply'
            inputs:
              provider: 'azurerm'
              command: 'apply'
              workingDirectory: '$(System.DefaultWorkingDirectory)/environments/dev'
              environmentServiceNameAzureRM: $(azureServiceConnection)
              commandOptions: '$(Pipeline.Workspace)/dev-tfplan-file/dev.tfplan'